# Анализ проекта и план улучшения научного отчёта (LLM-конвейер)

## 1. Слабые места текущей реализации

### 1.1 Запрет на внешние знания
- **Где:** `llm/system_prompt.txt`: «Не привлекайте внешние знания», «Не интерпретируйте "мир" — только переданную статистику».
- **Проблема:** Специалист по травелогам и ориентализму как раз опирается на теорию (Саид, постколониальные исследования, новая имперская история). Исключение теории даёт сухое описание цифр без интерпретации в рамках поля.
- **Следствие:** Отчёт читается как «статистическая сводка», а не как «исследовательский анализ в традиции ориентализма и изучения репрезентации».

### 1.2 Один большой запрос на научный отчёт
- **Где:** `llm/scientific_report.py` — один вызов `call_deepseek` с полным payload и одним пользовательским промптом.
- **Проблема:** Модель получает всё сразу и пишет все секции за один раз. Нет поэтапной «экспертизы» (сначала ключевые слова в теории, потом распределения, потом синтез).
- **Следствие:** Риск поверхностности и пропуска связей между блоками (keyness ↔ теоретические тропы, сети ↔ имперский взгляд).

### 1.3 Короткие и общие промпты по блокам
- **Где:** `llm/memo_engine.py` — `USER_PROMPTS` для representation, situation, keyness и т.д. — по 1–2 предложения.
- **Проблема:** Нет явных отсылок к концепциям (ориентализм, экзотизация, эссенциализация, «имперский взгляд», травелог как жанр). LLM не получает роли «специалиста по травелогам и русско-европейским связям».
- **Следствие:** Мемо получаются универсально-статистическими, без гуманитарной рамки.

### 1.4 Минимальный системный промпт для обзора PDF
- **Где:** `src/deepseek_analysis.py` — `SYSTEM_PROMPT` из 4 строк: «Ты исследователь травелогов и ориентализма. Анализируй только переданные данные…»
- **Проблема:** Нет теоретического брифинга, нет указания на постколониальную/имперскую оптику. Запрос к API — один общий «верни observations, probable_patterns, limitations».
- **Следствие:** Обзор для PDF слабо связан с научной литературой и рамкой «новая имперская история / травелоги».

### 1.5 Нет метаданных документов в payload
- **Где:** В LLM передаются только агрегаты (частоты, индексы, топ keyness). Имена файлов есть в данных, но не парсятся и не передаются в `scientific_report`/synthesis.
- **Проблема:** Если тексты подписаны как `Author_Year_Title.txt` (как в `archive_downloader`), автор и период могли бы использоваться для интерпретации (эволюция дискурса, различия между авторами). Сейчас LLM не может этого делать.
- **Следствие:** Упускается возможность «временной и авторской» интерпретации.

### 1.6 Дублирование и разрыв между synthesis и scientific_report
- **Где:** Два потока: `generate_synthesis` / `generate_synthesis_memo` (synthesis.json) и `generate_scientific_report` (scientific_report.json). Форматы и запросы разные.
- **Проблема:** Синтез даёт observation/theoretical_framing/hypotheses; научный отчёт пишет секции corpus…conclusion. Связь между ними только через «prior_interpretations» в payload научного отчёта. Нет явного шага «сначала синтез и теория, потом полный отчёт с опорой на них».
- **Следствие:** Возможная непоследовательность и повторения без углубления.

### 1.7 Нет явной «базы знаний» по полю
- **Где:** Нигде не подгружаются и не передаются в LLM краткие выжимки по: Саид (ориентализм), травелоги как жанр, русско-европейские связи, новая имперская история, эссенциализация в дискурсе.
- **Проблема:** Модель опирается только на свои веса. Даже при снятии запрета «не привлекать внешние знания» без явной передачи ключевых концепций интерпретация остаётся общей.
- **Следствие:** Невозможно получить отчёт «как от профессионала в этой области» без внедрения поля в промпты.

---

## 2. Цель: максимум полезной информации и полноценный научный отчёт

- **Полезная информация на выходе:** структурированные выводы, проверяемые гипотезы, связь с теорией, ограничения метода, рекомендации по дальнейшей работе.
- **Научный отчёт «как от специалиста»:** травелоги, русско-европейские связи, постколониальные и новая имперская история — явно заданы в роли и в базе знаний; интерпретация данных опирается на эти рамки и на имеющиеся в интернете/литературе концепции (через внедрённый брифинг).

---

## 3. Предлагаемый конвейер промптов (с опорой на базу знаний)

### 3.1 База знаний (в проекте + при желании интернет)
- **Файл(ы) в проекте:** например `resources/knowledge/domain_briefing.txt` (или несколько: `orientalism.txt`, `travel_writing.txt`, `russian_imperial_siberia.txt`).
- **Содержимое:** краткие, нейтральные выжимки:
  - Ориентализм (Саид): связь знания и власти, репрезентация «Востока» как экзотичного/отсталого, роль травелогов в формировании образа.
  - Травелоги: жанр, связь с имперским взглядом, стереотипизация, эссенциализация.
  - Русская империя и Сибирь: «изобретение» Сибири в текстах, русско-европейский контекст, колониальный/имперский дискурс.
  - Новая имперская история и постколониальные исследования: взгляд на источники и репрезентацию.
- **Обновление:** при необходимости — ручное обновление из авторитетных источников (Wikipedia, академические обзоры); опционально в будущем — автоматическая подстановка из поиска/RAG.

### 3.2 Системный промпт с ролью и рамкой
- Заменить установку «не привлекать внешние знания» на: «опирайся на переданную ниже теоретическую рамку (ориентализм, травелоги, имперский дискурс) и строго на переданные данные; не выдумывай факты о корпусе».
- В начало системного промпта (или в первый пользовательский блок) подставлять содержимое `domain_briefing.txt` как «Теоретическая рамка для интерпретации».
- Роль: «Ты эксперт по травелогам, русско-европейским связям, постколониальным исследованиям и новой имперской истории; твоя задача — интерпретировать количественные и лексические данные корпуса в этой рамке».

### 3.3 Поэтапный конвейер для научного отчёта (опция «полный научный режим»)
1. **Шаг 0 (опционально):** Загрузка и подстановка базы знаний в системный промпт.
2. **Мемо по блокам (уже есть):** Усилить пользовательские промпты — добавить отсылки к концепциям (например, для keyness: «интерпретируй в свете ориенталистских тропов и экзотизации в травелогах»).
3. **Синтез (уже есть):** В промпт синтеза явно включить: «дай theoretical_framing в терминах ориентализма и новой имперской истории; укажи, как индексы согласуются с этими рамками».
4. **Научный отчёт — два варианта:**
   - **Вариант A (текущий, улучшенный):** Один вызов, но с расширенным системным промптом (роль + база знаний) и уточнённым пользовательским промптом (секции, связь с prior_interpretations и теорией).
   - **Вариант B (поэтапный):** Несколько вызовов — например сначала «корпус и распределения», потом «keyness и эссенциализация», потом «сети и индексы», потом «профили и заключение»; каждый шаг получает предыдущие выводы и теоретический брифинг. Итог склеивается в один отчёт. Даёт более глубокие секции при большем расходе токенов.

### 3.4 Метаданные документов
- Если имена файлов в `data/texts/` имеют вид `Author_Year_Title.txt` (или из отдельного CSV/JSON метаданных), парсить author и year и добавлять в payload для научного отчёта и синтеза (например, список документов с author, year, filename).
- В промпте: «Учитывай, что корпус может содержать тексты разных авторов и периодов; при наличии метаданных укажи на возможную временную или авторскую вариацию».

### 3.5 Единый обзор для PDF (deepseek_analysis)
- Расширить системный промпт в `src/deepseek_analysis.py`: та же роль и (при наличии) фрагмент базы знаний.
- В запросе явно просить: «probable_patterns сформулируй в терминах ориентализма и репрезентации "других" в травелогах».

---

## 4. Что реализовано в коде (после доработок)

- **`resources/knowledge/domain_briefing.txt`** — база знаний для подстановки в промпты (ориентализм, травелоги, Сибирь в имперском дискурсе).
- **`llm/system_prompt.txt`** — обновлён: роль эксперта + место для вставки теоретической рамки; снят жёсткий запрет на использование переданной теории.
- **`llm/knowledge_loader.py`** — загрузка domain_briefing и подстановка в системный промпт.
- **`llm/memo_engine.py`** — расширены USER_PROMPTS отсылками к ориентализму/травелогам/эссенциализации (и опционально подстановка брифинга).
- **`llm/scientific_report.py`** — научный отчёт с использованием загруженной базы знаний в системном промпте; уточнённый пользовательский промпт (секции + теоретическая интерпретация).
- **`src/deepseek_analysis.py`** — расширен системный промпт (роль + при возможности брифинг); в запросе — явная просьба к теоретической интерпретации.
- **Опционально:** парсинг author/year из имён файлов и передача в payload научного отчёта (если имена соответствуют соглашению).

В результате конвейер даёт на выходе научный отчёт, который опирается на имеющуюся в проекте (и при желании пополняемую из интернета) базу знаний и читается как анализ специалиста по травелогам, русско-европейским связям и постколониальным/имперским исследованиям.
